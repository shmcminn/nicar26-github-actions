name: Daily Big Ten WBB Session 3 Price

on:
  schedule:
    # Cron format is: minute hour day-of-month month day-of-week (in UTC on GitHub).
    # This runs at minute 0, hour 9 UTC, every day, only in Nov-Apr.
    # 4am ET during standard time (09:00 UTC), only Nov-Apr.
    - cron: "0 9 * 11,12,1,2,3,4 *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # "jobs" is where you define one or more units of work in the workflow.
  # Each job can have its own runner and its own list of steps.
  fetch-stubhub-prices:
    # "runs-on" picks the machine image GitHub provides for this job.
    # ubuntu-latest means a fresh Linux runner for each run.
    runs-on: ubuntu-latest
    steps:
      # Pull repository files onto the runner.
      - name: Check out repository
        uses: actions/checkout@v4

      # Install Python so we can run the StubHub analysis script.
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Compute today's date in Eastern Time for file naming.
      - name: Set ET date
        run: |
          echo "TARGET_DATE_ET=$(TZ=America/New_York date +%Y%m%d)" >> "$GITHUB_ENV"
          echo "RUN_TIMESTAMP_ET=$(TZ=America/New_York date '+%Y-%m-%d %H:%M:%S %Z')" >> "$GITHUB_ENV"

      # Download the tournament page HTML into data/raw.
      - name: Download StubHub raw HTML
        run: |
          mkdir -p data/raw
          curl -s \
            "https://www.stubhub.com/big-ten-women-s-basketball-tournament-indianapolis-tickets-3-5-2026/event/157634620/" \
            -o "data/raw/stubhub_session3_event_${TARGET_DATE_ET}.html"

      # Analyze raw HTML for Session 3 only (event id 157634620).
      - name: Analyze Session 3 price
        run: |
          python scripts/analyze_stubhub_big10wbt.py \
            --date "${TARGET_DATE_ET}" \
            --timestamp "${RUN_TIMESTAMP_ET}" \
            --stubhub-html "data/raw/stubhub_session3_event_${TARGET_DATE_ET}.html" \
            --history-csv "data/stubhub_big10wbt_session3_history.csv"

      # Build a student-visible HTML snapshot with token-like values redacted.
      - name: Create sanitized HTML snapshot
        run: |
          mkdir -p data/raw_public
          cp \
            "data/raw/stubhub_session3_event_${TARGET_DATE_ET}.html" \
            "data/raw_public/stubhub_session3_event_${TARGET_DATE_ET}.html"
          perl -0777 -i -pe '
            s/"([^"]*(?:key|token|secret|client_id|client_key|app_insights|oid)[^"]*)":"[^"]*"/"$1":"[REDACTED]"/gi;
            s/"(googleRecaptchaV[23]Key|binaryNow)":"?[^",}]*"?/"$1":"[REDACTED]"/g;
            s/pk\.[A-Za-z0-9._-]+/[REDACTED_MAPBOX_TOKEN]/g;
            s/AIza[0-9A-Za-z_-]{20,}/[REDACTED_GOOGLE_KEY]/g;
          ' "data/raw_public/stubhub_session3_event_${TARGET_DATE_ET}.html"

      # Commit and push the updated history CSV plus sanitized HTML snapshot.
      - name: Commit updated files if changed
        run: |
          # The GitHub Actions runner is a temporary machine with no git identity set.
          # We set a bot name/email here so git allows creating a commit.
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add \
            "data/raw_public/stubhub_session3_event_${TARGET_DATE_ET}.html" \
            "data/stubhub_big10wbt_session3_history.csv"
          if git diff --cached --quiet; then
            echo "No data changes detected."
          else
            git commit -m "Update StubHub Session 3 price for ${TARGET_DATE_ET}"
            git push
          fi
